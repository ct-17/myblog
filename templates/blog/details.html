{% extends "page/page.html" %}
{% load staticfiles %}
{% load i18n %}
{% block title %}Blog ct | {{ object.title }}{% endblock %}

{% block content %}
    <div class=gdlr-core-pbf-element>
        <div class="gdlr-core-blog-item gdlr-core-item-pdb clearfix  gdlr-core-style-blog-full">
            <div class="gdlr-core-blog-item-holder gdlr-core-js-2 clearfix" data-layout=fitrows>
                <div class="gdlr-core-item-list gdlr-core-blog-full gdlr-core-style-left">
                    <div class=gdlr-core-blog-full-content-wrap>
                        <div class="gdlr-core-blog-full-head clearfix">
                            <div class=gdlr-core-blog-full-head-right>
                                <h1 class="gdlr-core-blog-title gdlr-core-skin-title" id="h3_2207_3">
                                    {{ object.title }}
                                </h1>
                                <div class="gdlr-core-blog-info-wrapper gdlr-core-skin-divider">
                                    <span class="gdlr-core-blog-info gdlr-core-blog-info-font gdlr-core-skin-caption gdlr-core-blog-info-author">
                                        <img alt src="{% static 'images/admin/account.svg' %}" class='avatar avatar-50 photo' height=50 width=50>
                                        <a href="#" title="Author" rel=author>{{ object.author }}</a>
                                    </span>
                                    <span class="gdlr-core-blog-info gdlr-core-blog-info-font gdlr-core-skin-caption gdlr-core-blog-info-date">
                                        <a href="#" title="Date">{{ object.timestamp | date:"d/m/Y" }}</a>
                                    </span>
                                    <span class="gdlr-core-blog-info gdlr-core-blog-info-font gdlr-core-skin-caption gdlr-core-blog-info-category">
                                        <a href="#" title="Tag" rel=tag>{{ object.kind }}</a>
                                    </span>
                                    <span class=" gdlr-core-blog-info-font gdlr-core-skin-caption gdlr-core-blog-info-like">
                                        {% if user.is_authenticated %}
                                            <a class="ct-button ct-button-like" data-href='{{ object.get_api_like_url }}' data-likes='{{ object.like.count }}' href='{{ object.get_like_url }}'><i class="fa fa-heart"></i> {{ object.like.count }} | Like</a>
                                        {% else %}
                                            <a href="#" class="ct-button ct-button-like"><i class="fa fa-heart"></i> {{ object.like.count }} | Like</a>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="gdlr-core-blog-content">{{ object.content | safe }}</div>
                    </div>
                </div>
            </div>
            <hr  width="100%" align="center" size="20px"/>
        </div>

        <!-- Commnet form -->
        <div class="form_commnet">
            {% if request.user.is_authenticated %}
            <label for="comments">Comments</label>
            <form method='POST' action="{% url 'blog:detail' kind=object.kind slug=object.slug %}">
                {% csrf_token %}
                {{ form.body }}
                <input type="submit" value='{% trans "comment" %}' id="button_commnet" />
            </form>
            {% else %}
                <label for="comments">Comments</label>
                <form action=".">
                    <textarea name="body" cols="40" rows="10" required="" id="id_body"></textarea>
                    <a type="submit" href="{% url 'register' %}" id="button_commnet">{% trans "COMMENT" %}</a>
                </form>
            {% endif %}
        </div>
        <br/>

        <!-- list comments -->
        <div class="comments" direction="left">
            {% for comment in object.comments.all %}
                <div class="comment">
                    <div class="img_author">
                        <img src="{% static "images/blog/defaults/user.svg" %}" />
                    </div>
                    <div class="body_comment" direction="right">
                        <span class="size_text_author">{{ comment.author }}</span>
                        <div>
                            <span class="size_text_content">{{ comment.body|safe }}</span>
                        </div>
                        <div class="infor_comment">
                            <a id="btn_reply" onclick="OpenFormReply()" href="#">{% trans "reply" %}</a>
                            <span aria-hidden="true"> Â· </span>
                            <small>{{ comment.date|timesince }}</small>
                        </div>
                        <div class="replys">
                            <div id="form_reply">
                                {% if request.user.is_authenticated %}
                                    <form method='POST' action="{% url 'blog:detail' kind=object.kind slug=object.slug %}">
                                        {% csrf_token %}
                                        {{ form.body }}
                                        <input type="hidden" name='parent_id' value="{{ comment.id }}" />
                                        <input type="submit" value='{% trans "reply" %}' id="button_reply" />
                                    </form>
                                {% else %}
                                    <form action=".">
                                        <textarea name="body" cols="40" rows="10" required="" id="id_content_reply"></textarea>
                                        <a type="submit" href="{% url 'register' %}" id="button_reply">{% trans "REPLY" %}</a>
                                    </form>
                                {% endif %}
                            </div>
                            <div class="reply">
                                {% for reply in comment.replys.reply %}
                                    <div class="comment">
                                        <div class="img_author">
                                            <img src="{% static "images/blog/defaults/user.svg" %}" />
                                        </div>
                                        <div direction="right">
                                            <span class="size_text_author">{{ reply.author }}</span>
                                            <div>
                                                <span class="size_text_content">{{ reply.body|safe }}</span>
                                            </div>
                                            <div class="infor_comment">
                                                <small>{{ reply.date|timesince }}</small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    <script>
        $(document).ready(function(){
            function updateText(btn, newCount, verb){
                //btn.text(newCount + "|" + verb)
                btn.html("<i class='fa fa-heart'></i> " + newCount + " | " + verb)
            }

            $(".ct-button-like").click(function(e){
                e.preventDefault()
                var this_ = $(this)
                var likeUrl = this_.attr("data-href")
                
                if (likeUrl){
                    $.ajax({
                        url: likeUrl,
                        method: "GET",
                        data: {},
                        success: function(data){
                        if (data.liked){
                            updateText(this_, data.total + 1, "Like")
                        } else {
                            updateText(this_, data.total - 1, "Like")
                        }

                        }, error: function(error){
                        console.log(error)
                        console.log("error")
                        }
                    })
                }
            
            })
        })
    </script>
{% endblock %}